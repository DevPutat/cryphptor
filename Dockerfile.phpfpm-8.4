# Dockerfile.phpfpm-8.4 - для выполнения зашифрованных PHP файлов на PHP 8.4

# Аргумент для выбора версии PHP
ARG PHP_VERSION=8.4-fpm
FROM php:${PHP_VERSION}

# Устанавливаем зависимости для сборки расширения
RUN apt-get update && apt-get install -y \
    git \
    libssl-dev \
    && docker-php-source extract \
    && rm -rf /var/lib/apt/lists/*

# ВАЖНО: НЕ устанавливаем opcache - он конфликтует с zend_compile_file хуком

# Копируем исходный код расширения
COPY . /usr/src/cryphptor

# Собираем и устанавливаем расширение
WORKDIR /usr/src/cryphptor/dist/phpext
RUN phpize \
    && ./configure \
    && make \
    && make install \
    && docker-php-ext-enable cryphptor

# Устанавливаем рабочую директорию
WORKDIR /var/www/html

# КРИТИЧЕСКОЕ: Без дешифровки при старте!
# Расширение дешифрует файлы в памяти при интерпретации
# В контейнере хранятся ТОЛЬКО зашифрованные файлы