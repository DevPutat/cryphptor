# cryphptor

cryphptor - это инструмент для шифрования PHP файлов с возможностью автоматической дешифровки во время выполнения. Проект состоит из двух основных компонентов:

1.  **CLI инструмент** (`cryphptor`) для шифрования PHP файлов.
2.  **PHP расширение** для автоматической дешифровки файлов на лету при их загрузке интерпретатором PHP.

## Как это работает

1.  Исходные PHP файлы шифруются с помощью CLI инструмента `cryphptor`.
2.  Зашифрованные файлы развертываются на сервере.
3.  При запуске PHP-приложения PHP расширение предоставляет stream wrapper `cryphptor://`, который позволяет читать зашифрованные файлы с автоматической дешифровкой в памяти.
4.  Для доступа к зашифрованным файлам в PHP коде можно использовать либо вызов `cryphptor_open_encrypted('/path/to/file')`, либо напрямую использовать префикс `cryphptor://` при чтении файлов.
5.  Таким образом, код остается зашифрованным на диске, но может быть безопасно прочитан и выполнен в памяти.

## Сборка проекта

### Требования

-   Go 1.24 или выше
-   PHP 7.4, 8.3 или 8.4 с заголовочными файлами (php-dev)
-   OpenSSL development libraries
-   Docker (для сборки в контейнерах)

### Сборка CLI инструмента и PHP расширения

```bash
# Сборка всех компонентов
make build

# Сборка только CLI инструмента
make cryphptor

# Сборка только инструмента для подготовки PHP расширения
make phpext_builder

# Очистка сборочных файлов
make clean
```

### Сборка Docker образов

```bash
# Сборка всех Docker образов
make docker

# Сборка образа с CLI инструментом
make cryphptor-docker

# Сборка образа с PHP-FPM и расширением (последняя версия)
make docker-latest

# Сборка образа с PHP-FPM 7.4 и расширением
make docker-74

# Сборка образа с PHP-FPM 8.4 и расширением
make docker-84
```

## Использование

### Шифрование файлов

```bash
# Шифрование файлов в директории
./dist/cryphptor -key=\"ваш_ключ_шифрования\" -root=\"/path/to/source\" -dist=\"/path/to/encrypted\"
```

### Запуск в Docker

```bash
# Запуск контейнера с PHP-FPM и расширением
docker run -d \
  --name cryphptor-phpfpm \
  -e DECRYPTION_KEY="ваш_ключ_шифрования" \
  -v /path/to/encrypted/files:/var/www/html \
  cryphptor-phpfpm
```

### Использование PHP расширения

Для использования PHP расширения в вашем приложении:

1. Убедитесь, что расширение скомпилировано и установлено в PHP
2. Установите переменную окружения `DECRYPTION_KEY` с тем же ключом, который использовался для шифрования файлов
3. Зашифрованные файлы можно читать с помощью stream wrapper `cryphptor://`

```php
// Пример использования
if (extension_loaded('cryphptor')) {
    // Открытие зашифрованного файла с автоматической дешифровкой
    $content = file_get_contents('cryphptor:///path/to/encrypted/file.php');
    echo $content;
    
    // Или с использованием функции из расширения
    $encrypted_path = cryphptor_open_encrypted('/path/to/encrypted/file.php');
    $content = file_get_contents($encrypted_path);
    echo $content;
}
```

## Тестирование

```bash
# Запуск unit-тестов
make test

# Запуск теста полного конвейера шифрования/дешифрования
./test_pipeline.sh
```

## Структура проекта

-   `cmd/cryphptor/` - Исходный код CLI инструмента
-   `cmd/phpext_builder/` - Инструмент для подготовки файлов PHP расширения к сборке
-   `internal/cryptolib/` - Библиотека для шифрования/дешифрования
-   `internal/scanner/` - Сканер для поиска PHP файлов
-   `internal/phpext/` - Исходный код PHP расширения
-   `dist/` - Директория для сборочных файлов
-   `Dockerfile.*` - Docker файлы для разных компонентов
-   `test*.php` - Тестовые файлы
-   `test_pipeline.sh` - Скрипт для тестирования полного конвейера

## Лицензия

MIT