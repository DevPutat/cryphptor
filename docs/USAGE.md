# Документация по проекту cryphptor

## Обзор

cryphptor - это инструмент для шифрования PHP файлов с возможностью автоматической дешифровки во время выполнения. Проект состоит из двух основных компонентов:

1. **CLI инструмент** (`cryphptor`) для шифрования PHP файлов
2. **PHP расширение** для автоматической дешифровки файлов на лету при их загрузке интерпретатором PHP

## Архитектура

### CLI инструмент

CLI инструмент реализован на языке Go и предоставляет следующие возможности:
- Шифрование PHP файлов с использованием AES-256-GCM
- Генерация ключа через HKDF
- Поддержка шифрования целых директорий
- Возможность исключать определенные файлы/директории из шифрования

### PHP расширение

PHP расширение реализовано на языке C и предоставляет:
- Stream wrapper `cryphptor://` для чтения зашифрованных файлов
- Автоматическую дешифровку содержимого файлов в памяти
- Интеграцию с системой загрузки файлов PHP

## Установка и настройка

### Требования

- Go 1.24 или выше
- PHP 7.4, 8.3 или 8.4 с заголовочными файлами (php-dev)
- OpenSSL development libraries
- Docker (для сборки в контейнерах)

### Сборка проекта

```bash
# Сборка всех компонентов
make build

# Сборка только CLI инструмента
make cryphptor

# Сборка только инструмента для подготовки PHP расширения
make phpext_builder
```

## Использование

### Шифрование файлов

```bash
# Шифрование файлов в директории
./dist/cryphptor -key="ваш_ключ_шифрования" -root="/path/to/source" -dist="/path/to/encrypted"
```

Ключ шифрования должен быть длиной от 16 до 32 байт. Если ключ короче 32 байт, он будет дополнен нулями до 32 байт. Если ключ длиннее 32 байт, он будет обрезан до 32 байт.

### Использование с PHP расширением

Для использования расширения:

1. Скомпилируйте расширение и установите его в PHP
2. Установите переменную окружения `DECRYPTION_KEY` с тем же ключом, который использовался для шифрования файлов
3. Используйте stream wrapper `cryphptor://` для чтения зашифрованных файлов

```php
// Пример использования
if (extension_loaded('cryphptor')) {
    // Открытие зашифрованного файла с автоматической дешифровкой
    $content = file_get_contents('cryphptor:///path/to/encrypted/file.php');
    echo $content;
    
    // Или с использованием функции из расширения
    $encrypted_path = cryphptor_open_encrypted('/path/to/encrypted/file.php');
    $content = file_get_contents($encrypted_path);
    echo $content;
}
```

## Принцип работы

1. Исходные PHP файлы шифруются с помощью CLI инструмента `cryphptor`
2. Зашифрованные файлы развертываются на сервере
3. При запуске PHP-приложения PHP расширение предоставляет stream wrapper `cryphptor://`, который позволяет читать зашифрованные файлы с автоматической дешифровкой в памяти
4. Для доступа к зашифрованным файлам в PHP коде можно использовать либо вызов `cryphptor_open_encrypted('/path/to/file')`, либо напрямую использовать префикс `cryphptor://` при чтении файлов
5. Таким образом, код остается зашифрованным на диске, но может быть безопасно прочитан и выполнен в памяти

## Алгоритмы и форматы

### Шифрование

- Алгоритм: AES-256-GCM
- Генерация ключа: HKDF с SHA-256
- Длина nonce: 12 байт
- Длина тега аутентификации: 16 байт

### Формат зашифрованного файла

Зашифрованный файл состоит из:
- 12 байт: nonce
- Остальная часть: зашифрованные данные с встроенным тегом аутентификации

## Безопасность

- Используется сильное шифрование AES-256-GCM
- Ключ генерируется через HKDF с использованием nonce
- Тег аутентификации обеспечивает целостность данных
- Зашифрованные файлы не могут быть изменены без обнаружения

## Docker поддержка

Проект предоставляет Docker файлы для разных версий PHP:

- `Dockerfile.phpfpm` - последняя версия PHP
- `Dockerfile.phpfpm-7.4` - PHP 7.4
- `Dockerfile.phpfpm-8.4` - PHP 8.4

## Тестирование

Для тестирования полного конвейера шифрования/дешифрования:

```bash
./test_pipeline.sh
```

Для запуска unit-тестов:

```bash
make test
```

## Лицензия

MIT